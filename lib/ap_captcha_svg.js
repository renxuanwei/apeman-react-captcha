/**
 * SVG captcha.
 * DO NOT use svg base captcha in production, since it may be parsable by bots.
 * You need to convert to bitmap like png beforehand.
 * @constructor ApCaptchaSvg
 */

"use strict";

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

const React = require('react'),
      ReactDOM = require('react-dom'),
      randomval = require('randomval'),
      numcal = require('numcal'),
      types = React.PropTypes;

/** @lends ApCaptchaSvg */
let ApCaptchaSvg = React.createClass({
    displayName: 'ApCaptchaSvg',

    //--------------------
    // Specs
    //--------------------

    propsTypes: {
        version: types.string,
        text: types.string.isRequired,
        width: types.number,
        height: types.number
    },

    getDefaultProps: function () {
        return {
            version: '1.1',
            xmlns: 'http://www.w3.org/2000/svg',
            text: null,
            width: 256,
            height: 92
        };
    },

    render: function () {
        let s = this,
            props = s.props;

        let color = '#555';

        let width = props.width,
            height = props.height;

        let backgrounds = [0, 1, 2, 3].map((val, i, arr) => {
            let len = arr.length;
            let margin = width * 0.2;
            let rate = (i + 0.5) / len;
            return s._stripeBlock(rate, color, {
                key: `bg-${ i }`,
                width: width / len + margin * 2,
                height: height + margin * 2,
                x: width * rate - margin,
                y: 0 - margin
            });
        });

        let texts = props.text.split('').map((letter, i, letters) => {
            let indices = [0, 1, 2, 3, 4, 5],
                real = randomval.randomInt(0, indices.length - 1);
            let texts = indices.map(j => {
                let rate = i / letters.length,
                    key = `letter-${ i }-${ j }`;
                if (j === real) {
                    return s._renderLetter(letter, rate, {
                        key: key,
                        fill: color
                    });
                } else {
                    return s._renderLetter(s._dummyLetter(), rate, {
                        key: key,
                        fill: `rgba(255,255,255,${ 0.01 * Math.random() })`
                    });
                }
            });
            return React.createElement(
                'g',
                { key: `letter-group-${ i }` },
                texts
            );
        });
        return React.createElement(
            'svg',
            { version: props.version,
                width: width,
                height: height,
                viewBox: `0 0 ${ width } ${ height }`
            },
            React.createElement(
                'g',
                null,
                backgrounds
            ),
            React.createElement(
                'g',
                null,
                texts
            )
        );
    },

    //--------------------
    // Specs
    //--------------------

    _renderLetter: function (letter, rate, textProps) {
        let s = this,
            props = s.props;

        let padding = 16;

        let w = props.width - padding * 2,
            h = props.height;

        let moveRange = h / 20,
            move = randomval.randomInt.bind(randomval, moveRange * -1, moveRange);

        let fontSize = h * 0.8;
        let x = padding + w * rate + fontSize / 4,
            y = fontSize,
            rotateRange = 40,
            rotate = randomval.randomInt(-rotateRange, rotateRange);

        return React.createElement(
            'text',
            _extends({ x: x,
                y: y,
                fontSize: fontSize,
                transform: `translate(${ move() }, ${ move() }) rotate(${ rotate }, ${ x }, ${ y })`
            }, textProps),
            letter
        );
    },

    _dummyLetter: function () {
        const letters = "1234567890abcdefg";
        let len = letters.length;
        return letters[randomval.randomInt(0, len - 1)];
    },

    _stripeBlock: function (rate, color, blockProps) {
        let s = this,
            props = s.props;

        let rotate = randomval.randomInt(-90, 90);

        let lines = [],
            lineWidth = 1;
        let w = blockProps.width,
            h = blockProps.height;

        let left = w * -0.5,
            right = w * 1.5;

        for (let x = left; x < right; x += lineWidth * 6) {
            lines.push(React.createElement('line', { x1: x,
                y1: 0,
                x2: x,
                y2: h,
                lineWidth: lineWidth,
                key: `line-${ x }`,
                stroke: color
            }));
        }

        return React.createElement(
            'svg',
            blockProps,
            React.createElement(
                'g',
                { transform: `scale(1.3) rotate(${ rotate }, ${ blockProps.width / 2 }, ${ blockProps.height / 2 })` },
                lines
            )
        );
    }

});

module.exports = ApCaptchaSvg;
//# sourceMappingURL=data:application/json;base64,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Z0JBQzNGLEtBQUs7YUFDTjtTQUNGLENBQ1Q7S0FDSjs7Q0FFSixDQUFDLENBQUM7O0FBRUgsTUFBTSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMiLCJmaWxlIjoiYXBfY2FwdGNoYV9zdmcuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL29rdW5pc2hpdGFrYS9wcm9qZWN0cy9hcGVtYW4tcmVhY3QtbGFiby9hcGVtYW4tcmVhY3QtY2FwdGNoYS9saWIvanN4Iiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTVkcgY2FwdGNoYS5cbiAqIERPIE5PVCB1c2Ugc3ZnIGJhc2UgY2FwdGNoYSBpbiBwcm9kdWN0aW9uLCBzaW5jZSBpdCBtYXkgYmUgcGFyc2FibGUgYnkgYm90cy5cbiAqIFlvdSBuZWVkIHRvIGNvbnZlcnQgdG8gYml0bWFwIGxpa2UgcG5nIGJlZm9yZWhhbmQuXG4gKiBAY29uc3RydWN0b3IgQXBDYXB0Y2hhU3ZnXG4gKi9cblxuXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKSxcbiAgICBSZWFjdERPTSA9IHJlcXVpcmUoJ3JlYWN0LWRvbScpLFxuICAgIHJhbmRvbXZhbCA9IHJlcXVpcmUoJ3JhbmRvbXZhbCcpLFxuICAgIG51bWNhbCA9IHJlcXVpcmUoJ251bWNhbCcpLFxuICAgIHR5cGVzID0gUmVhY3QuUHJvcFR5cGVzO1xuXG4vKiogQGxlbmRzIEFwQ2FwdGNoYVN2ZyAqL1xubGV0IEFwQ2FwdGNoYVN2ZyA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTcGVjc1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIHByb3BzVHlwZXM6IHtcbiAgICAgICAgdmVyc2lvbjogdHlwZXMuc3RyaW5nLFxuICAgICAgICB0ZXh0OiB0eXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICAgICAgd2lkdGg6IHR5cGVzLm51bWJlcixcbiAgICAgICAgaGVpZ2h0OiB0eXBlcy5udW1iZXJcbiAgICB9LFxuXG4gICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2ZXJzaW9uOiAnMS4xJyxcbiAgICAgICAgICAgIHhtbG5zOiAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLFxuICAgICAgICAgICAgdGV4dDogbnVsbCxcbiAgICAgICAgICAgIHdpZHRoOiAyNTYsXG4gICAgICAgICAgICBoZWlnaHQ6IDkyXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXMsXG4gICAgICAgICAgICBwcm9wcyA9IHMucHJvcHM7XG5cbiAgICAgICAgbGV0IGNvbG9yID0gJyM1NTUnO1xuXG4gICAgICAgIGxldCB3aWR0aCA9IHByb3BzLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0ID0gcHJvcHMuaGVpZ2h0O1xuXG4gICAgICAgIGxldCBiYWNrZ3JvdW5kcyA9IFswLCAxLCAyLCAzXS5tYXAoKHZhbCwgaSwgYXJyKT0+IHtcbiAgICAgICAgICAgIGxldCBsZW4gPSBhcnIubGVuZ3RoO1xuICAgICAgICAgICAgbGV0IG1hcmdpbiA9IHdpZHRoICogMC4yO1xuICAgICAgICAgICAgbGV0IHJhdGUgPSAoaSArIDAuNSkgLyBsZW47XG4gICAgICAgICAgICByZXR1cm4gcy5fc3RyaXBlQmxvY2socmF0ZSwgY29sb3IsIHtcbiAgICAgICAgICAgICAgICBrZXk6IGBiZy0ke2l9YCxcbiAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGggLyBsZW4gKyAobWFyZ2luICogMiksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgKyAobWFyZ2luICogMiksXG4gICAgICAgICAgICAgICAgeDogd2lkdGggKiByYXRlIC0gbWFyZ2luLFxuICAgICAgICAgICAgICAgIHk6IDAgLSBtYXJnaW5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgdGV4dHMgPSBwcm9wcy50ZXh0LnNwbGl0KCcnKS5tYXAoKGxldHRlciwgaSwgbGV0dGVycyk9PiB7XG4gICAgICAgICAgICBsZXQgaW5kaWNlcyA9IFswLCAxLCAyLCAzLCA0LCA1XSxcbiAgICAgICAgICAgICAgICByZWFsID0gcmFuZG9tdmFsLnJhbmRvbUludCgwLCBpbmRpY2VzLmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgbGV0IHRleHRzID0gaW5kaWNlcy5tYXAoKGopID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcmF0ZSA9IGkgLyBsZXR0ZXJzLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAga2V5ID0gYGxldHRlci0ke2l9LSR7an1gO1xuICAgICAgICAgICAgICAgIGlmIChqID09PSByZWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzLl9yZW5kZXJMZXR0ZXIobGV0dGVyLCByYXRlLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6IGNvbG9yXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzLl9yZW5kZXJMZXR0ZXIocy5fZHVtbXlMZXR0ZXIoKSwgcmF0ZSwge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBgcmdiYSgyNTUsMjU1LDI1NSwkezAuMDEgKiBNYXRoLnJhbmRvbSgpfSlgXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZyBrZXk9e2BsZXR0ZXItZ3JvdXAtJHtpfWB9Pnt0ZXh0c308L2c+XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxzdmcgdmVyc2lvbj17cHJvcHMudmVyc2lvbn1cbiAgICAgICAgICAgICAgICAgd2lkdGg9e3dpZHRofVxuICAgICAgICAgICAgICAgICBoZWlnaHQ9e2hlaWdodH1cbiAgICAgICAgICAgICAgICAgdmlld0JveD17YDAgMCAke3dpZHRofSAke2hlaWdodH1gfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxnPntiYWNrZ3JvdW5kc308L2c+XG4gICAgICAgICAgICAgICAgPGc+e3RleHRzfTwvZz5cbiAgICAgICAgICAgIDwvc3ZnPlxuICAgICAgICApXG4gICAgfSxcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTcGVjc1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIF9yZW5kZXJMZXR0ZXI6IGZ1bmN0aW9uIChsZXR0ZXIsIHJhdGUsIHRleHRQcm9wcykge1xuICAgICAgICBsZXQgcyA9IHRoaXMsXG4gICAgICAgICAgICBwcm9wcyA9IHMucHJvcHM7XG5cbiAgICAgICAgbGV0IHBhZGRpbmcgPSAxNjtcblxuICAgICAgICBsZXQgdyA9IHByb3BzLndpZHRoIC0gKHBhZGRpbmcgKiAyKSxcbiAgICAgICAgICAgIGggPSBwcm9wcy5oZWlnaHQ7XG5cbiAgICAgICAgbGV0IG1vdmVSYW5nZSA9IGggLyAyMCxcbiAgICAgICAgICAgIG1vdmUgPSByYW5kb212YWwucmFuZG9tSW50LmJpbmQocmFuZG9tdmFsLCBtb3ZlUmFuZ2UgKiAtMSwgbW92ZVJhbmdlKTtcblxuICAgICAgICBsZXQgZm9udFNpemUgPSBoICogMC44O1xuICAgICAgICBsZXQgeCA9IHBhZGRpbmcgKyB3ICogcmF0ZSArIChmb250U2l6ZSAvIDQpLFxuICAgICAgICAgICAgeSA9IGZvbnRTaXplLFxuICAgICAgICAgICAgcm90YXRlUmFuZ2UgPSA0MCxcbiAgICAgICAgICAgIHJvdGF0ZSA9IHJhbmRvbXZhbC5yYW5kb21JbnQoLXJvdGF0ZVJhbmdlLCByb3RhdGVSYW5nZSk7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDx0ZXh0IHg9e3h9XG4gICAgICAgICAgICAgICAgICB5PXt5fVxuICAgICAgICAgICAgICAgICAgZm9udFNpemU9e2ZvbnRTaXplfVxuICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtPXtgdHJhbnNsYXRlKCR7bW92ZSgpfSwgJHttb3ZlKCl9KSByb3RhdGUoJHtyb3RhdGV9LCAke3h9LCAke3l9KWB9XG4gICAgICAgICAgICAgICAgey4uLnRleHRQcm9wc31cbiAgICAgICAgICAgID57bGV0dGVyfTwvdGV4dD5cbiAgICAgICAgKVxuICAgIH0sXG5cbiAgICBfZHVtbXlMZXR0ZXI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgbGV0dGVycyA9IFwiMTIzNDU2Nzg5MGFiY2RlZmdcIjtcbiAgICAgICAgbGV0IGxlbiA9IGxldHRlcnMubGVuZ3RoO1xuICAgICAgICByZXR1cm4gbGV0dGVyc1tyYW5kb212YWwucmFuZG9tSW50KDAsIGxlbiAtIDEpXTtcbiAgICB9LFxuXG4gICAgX3N0cmlwZUJsb2NrOiBmdW5jdGlvbiAocmF0ZSwgY29sb3IsIGJsb2NrUHJvcHMpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLFxuICAgICAgICAgICAgcHJvcHMgPSBzLnByb3BzO1xuXG4gICAgICAgIGxldCByb3RhdGUgPSByYW5kb212YWwucmFuZG9tSW50KC05MCwgOTApO1xuXG4gICAgICAgIGxldCBsaW5lcyA9IFtdLFxuICAgICAgICAgICAgbGluZVdpZHRoID0gMTtcbiAgICAgICAgbGV0IHcgPSBibG9ja1Byb3BzLndpZHRoLFxuICAgICAgICAgICAgaCA9IGJsb2NrUHJvcHMuaGVpZ2h0O1xuXG4gICAgICAgIGxldCBsZWZ0ID0gdyAqIC0wLjUsXG4gICAgICAgICAgICByaWdodCA9IHcgKiAxLjU7XG5cbiAgICAgICAgZm9yIChsZXQgeCA9IGxlZnQ7IHggPCByaWdodDsgeCArPSBsaW5lV2lkdGggKiA2KSB7XG4gICAgICAgICAgICBsaW5lcy5wdXNoKFxuICAgICAgICAgICAgICAgIDxsaW5lIHgxPXt4fVxuICAgICAgICAgICAgICAgICAgICAgIHkxPXswfVxuICAgICAgICAgICAgICAgICAgICAgIHgyPXt4fVxuICAgICAgICAgICAgICAgICAgICAgIHkyPXtofVxuICAgICAgICAgICAgICAgICAgICAgIGxpbmVXaWR0aD17bGluZVdpZHRofVxuICAgICAgICAgICAgICAgICAgICAgIGtleT17YGxpbmUtJHt4fWB9XG4gICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlPXtjb2xvcn1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8c3ZnIHsuLi5ibG9ja1Byb3BzfT5cbiAgICAgICAgICAgICAgICA8ZyB0cmFuc2Zvcm09e2BzY2FsZSgxLjMpIHJvdGF0ZSgke3JvdGF0ZX0sICR7YmxvY2tQcm9wcy53aWR0aCAvIDJ9LCAke2Jsb2NrUHJvcHMuaGVpZ2h0IC8gMn0pYH0+XG4gICAgICAgICAgICAgICAgICAgIHtsaW5lc31cbiAgICAgICAgICAgICAgICA8L2c+XG4gICAgICAgICAgICA8L3N2Zz5cbiAgICAgICAgKVxuICAgIH1cblxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXBDYXB0Y2hhU3ZnO1xuIl19